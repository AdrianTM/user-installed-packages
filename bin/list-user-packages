#!/bin/bash
#Tool to list user installed packages
#V.0.1 by Melber and MX Devs, 21 January 2023
#License: GPL-3.0+


#set up translation

#source gettext.sh

#export TEXTDOMAINDIR=/usr/share/locale 
#export TEXTDOMAIN="mx-xxx"


#define some variables

TITLE="$(gettext 'User Installed Packages')"
CLASS="uip"
LUPPATH="$HOME/user-installed-packages"
ICONPATH="user-installed-packages"

#create folder

if [ ! -d $LUPPATH ]; then

	mkdir "$LUPPATH"

fi

if [ ! -f $LUPPATH/install.sh ]; then

	echo '#!/bin/sh
pkexec apt-get install --ignore-missing $(cat $HOME/user-installed-packages/install-list.txt)
' > $LUPPATH/install.sh

	chmod +x $LUPPATH/install.sh

fi

####################

#function uip_list

uip_list() {

TITLELIST="$(gettext 'User Installed Packages')"
CLASS="uip"
LUPPATH="$HOME/user-installed-packages"
#ICONPATH="/usr/share/pixmaps/mx-uip-icon.png"


#create list

NOW=$(date +%y"%m%d")

comm -23 <(apt-mark showmanual | sed 's/[: \t].*$//' | sort -u) <( { sed 's/[: \t].*$//' /usr/share/antiX/installed-packages.txt ; dpkg-query -W -f '${Depends}\n' | sed 's/([^)]*)//g; s/ //g; s/,/\n/g' | grep -vF '|' ; } | sort -u) > $LUPPATH/uip-$NOW.txt


#show list

TEXTLIST1="$(gettext 'This list has been saved under')"
TEXTLIST2="$(gettext 'You have installed the following packages:')"
UIPPATH="$LUPPATH/uip-$NOW.txt"


yad --title="$TITLELIST" --class="$CLASS" --window-icon="$ICONPATH" --text="$TEXTLIST1\n <i>$UIPPATH</i>\n\n$TEXTLIST2" --width=500 --height=800 --borders=20 --center --fixed --list --no-headers --separator="" --column=Style --text-align=left --button="gtk-save":3 --button="gtk-close" < $UIPPATH

GETOUT=$(echo "$?")


if [ "$GETOUT" = 3 ]; then

TITLE2="$(gettext 'Select location to save file')"

SAVETARGET=$(yad --title="$TITLE2" --class="$CLASS" --window-icon="$ICONPATH" --width=800 --height=500 --borders=20 --center --file --save --filename=$HOME/uip-$NOW.txt)

cp $LUPPATH/uip-$NOW.txt $SAVETARGET

else

	  exit

fi

}


####################

#function uip_load

uip_load() {

TITLELOAD="$(gettext 'Select UIP list to load')"
CLASS="uip"
LUPPATH="$HOME/user-installed-packages"
#ICONPATH="/usr/share/pixmaps/mx-uip-icon.png"


UIPLOAD=$(yad --title="$TITLELOAD" --class="$CLASS" --window-icon="$ICONPATH" \
 --width=800 --height=500 --borders=20 --center \
--file --filename=$HOME)


mapfile -t CHECKLIST < $UIPLOAD

CHECKLIST=( "${CHECKLIST[@]/#/__}" )

CHECKLIST=$(echo "${CHECKLIST[@]}" | sed -e 's/__/ TRUE /g')



TITLEINSTALL="$(gettext 'Install packages')"
TEXTINSTALL1="$(gettext 'Select which packages you want to install:')"

UIPINSTALL=$(yad --title="$TITLEINSTALL" --class="$CLASS" --window-icon="$ICONPATH" \
--text="$TEXTINSTALL1" --width=500 --height=800 --borders=20 --center --fixed --text-align=left --button="gtk-ok" --button="gtk-close" \
--checklist --list --no-headers --separator=" " --column=tick --column=package $CHECKLIST)

GETOUT=$(echo "$?")

if [ "$GETOUT" = 1 ]; then

	  exit

fi


echo "${UIPINSTALL[@]}" | sed -e 's/TRUE //g' > $LUPPATH/install-list.txt

cd $LUPPATH

xfce4-terminal -x bash -c "./install.sh; bash"

}


#export functions

export -f uip_list uip_load


###################################################################
###################################################################

#MAIN WINDOW
TITLE="$(gettext 'MX - User Installed Packages')"
CLASS="uip"
LUPPATH="$HOME/user-installed-packages"
#ICONPATH="/usr/share/pixmaps/mx-uip-icon.png"

TEXTMAIN1="$(gettext '<b>MX-UIP is a tool to view user installed packages.\n\n<i>What would you like to do?</i></b>\n')\n"
BUTTON1="$(gettext 'List the current user installed packages')"
BUTTON2="$(gettext 'Load a previously saved UIP list and install these packages')"


yad --title="$TITLE" --class="$CLASS" --window-icon="$ICONPATH" --borders=20 --center --width=600 --height=300 --fixed --form --text-align=center --text="$TEXTMAIN1" --button="gtk-close" \
--field="$BUTTON1:FBTN" 'bash -c uip_list' \
--field="$BUTTON2:FBTN" 'bash -c uip_load'


