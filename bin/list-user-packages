#!/bin/bash
#Tool to list user installed packages
#V.0.3 by MX Devs, 06 March 2023
#License: GPL-3.0+


#set up translation
source gettext.sh
export TEXTDOMAINDIR=/usr/share/locale 
export TEXTDOMAIN="user-installed-packages"


#define some variables

TITLE="$(gettext 'User Installed Packages')"
CLASS="uip"
ICONPATH="/usr/share/pixmaps/user-installed-packages.png"


####################

#function uip_list

uip_list() {

	TITLELIST="$(gettext 'User Installed Packages')"
 	CLASS="uip"
 	ICONPATH="/usr/share/pixmaps/user-installed-packages.png"


	#create list

	NOW=$(date +%y"%m%d")

  	UIPLIST=$(comm -23 <(apt-mark showmanual | sed 's/[: \t].*$//' | sort -u) <( { sed 's/[: \t].*$//' /usr/share/antiX/installed-packages.txt ; dpkg-query -W -f '${Depends}\n' | sed 's/([^)]*)//g; s/ //g; s/,/\n/g' | grep -vF '|' ; } | sort -u))


	#show list

  	TEXTLIST1="$(gettext 'You have installed the following packages:')"
  	TEXTBTNSAVE="$(gettext 'Save List')"

  	yad --title="$TITLELIST" --class="$CLASS" --window-icon="$ICONPATH" --text="<b>$TEXTLIST1</b>" --width=500 --height=600 --borders=20 --center --list --no-headers --no-selection --separator="" --column=Style --text-align=left --button="$TEXTBTNSAVE":3 --button="gtk-close" "$UIPLIST"

		GETOUT="$?"


	if [ "$GETOUT" = 3 ]; then

		TITLE2="$(gettext 'Select location to save file')"

		SAVETARGET=$(yad --title="$TITLE2" --class="$CLASS" --window-icon="$ICONPATH" --width=800 --height=500 --borders=20 --center --file --save --filename=$HOME/uip-$NOW.txt)

  		echo $SAVETARGET

  		echo "$UIPLIST" > $SAVETARGET


  	else

    	exit

	fi

}


####################

#function uip_load

uip_load() {

	TITLELOAD="$(gettext 'Select UIP list to load')"
 	CLASS="uip"
 	ICONPATH="/usr/share/pixmaps/user-installed-packages.png"


	UIPLOAD=$(yad --title="$TITLELOAD" --class="$CLASS" --window-icon="$ICONPATH" \
	--width=800 --height=500 --borders=20 --center \
	--file --filename=$HOME)

    	GETOUT=$(echo "$?")

 	if [ "$GETOUT" = 1 ]; then

		exit

	fi


  	mapfile -t CHECKLIST < $UIPLOAD

  	CHECKLIST=( "${CHECKLIST[@]/#/__}" )
  	CHECKLIST=$(echo "${CHECKLIST[@]}" | sed -e 's/__/ TRUE /g')

	TITLEINSTALL="$(gettext 'Install packages')"
	TEXTINSTALL1="$(gettext 'Select which packages you want to install:')"


  	UIPINSTALL=$(yad --title="$TITLEINSTALL" --class="$CLASS" --window-icon="$ICONPATH" \
  	--text="$TEXTINSTALL1" --width=500 --height=500 --borders=20 --center --text-align=left --button="gtk-ok" --button="gtk-close" \
  	--checklist --list --no-headers --separator=" " --column=tick --column=package $CHECKLIST)

  		GETOUT=$(echo "$?")

	if [ "$GETOUT" = 1 ]; then

		exit

	fi


 	UIPINSTALL=$(echo "${UIPINSTALL[@]}" | sed -e 's/TRUE //g')
 	HOLDMESSAGE="$(gettext 'Press Enter to exit')"
	
	#Install packages in separate terminal
 	#Anyone know how to hold the x-terminal-emulator open on completion???
 	x-terminal-emulator -e bash -c "sudo apt-get install --ignore-missing $(echo $UIPINSTALL); echo -n $(echo $HOLDMESSAGE); echo; read x"

  #Install packages in same terminal
  #sudo apt-get install --ignore-missing $UIPINSTALL

}


#export functions

export -f uip_list uip_load


###################################################################
###################################################################

#MAIN WINDOW
TITLE="$(gettext 'MX - User Installed Packages')"
CLASS="uip"
ICONPATH="/usr/share/pixmaps/user-installed-packages.png"

TEXTMAIN1="$(gettext '<b>MX-UIP is a tool to view user installed packages.\n\n<i>What would you like to do?</i></b>\n')\n"
BUTTON1="$(gettext 'List the current user installed packages')"
BUTTON2="$(gettext 'Load a previously saved UIP list and install these packages')"


yad --title="$TITLE" --class="$CLASS" --window-icon="$ICONPATH" --borders=20 --center --width=600 --height=300 --fixed --form --text-align=center --text="$TEXTMAIN1" --button="gtk-close" \
--field="$BUTTON1:FBTN" 'bash -c uip_list' \
--field="$BUTTON2:FBTN" 'bash -c uip_load'
